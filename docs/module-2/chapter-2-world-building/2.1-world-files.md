# 2.1 Gazebo World Files and Scene Graph

## Introduction

Gazebo world files define the virtual environment in which robots operate during simulation. These files specify the physics properties, terrain, static objects, lighting conditions, and initial robot positions. Understanding world files is crucial for creating realistic simulation environments that accurately represent real-world scenarios.

## World File Structure

Gazebo uses the Simulation Description Format (SDF) to define world files. SDF is an XML-based format that describes the complete simulation environment including:

- Physics engine configuration
- Terrain and static objects
- Lighting and visual properties
- Initial robot and object positions
- Simulation parameters

### Basic World File Template

```xml
<?xml version="1.0" ?>
<sdf version="1.7">
  <world name="my_world">
    <!-- Physics engine configuration -->
    <physics type="ode">
      <gravity>0 0 -9.8</gravity>
      <max_step_size>0.001</max_step_size>
      <real_time_factor>1</real_time_factor>
      <real_time_update_rate>1000</real_time_update_rate>
    </physics>

    <!-- Include standard models -->
    <include>
      <uri>model://ground_plane</uri>
    </include>

    <include>
      <uri>model://sun</uri>
    </include>

    <!-- Define custom objects -->
    <model name="my_robot">
      <!-- Robot definition here -->
    </model>

    <!-- Define static objects -->
    <model name="table">
      <pose>2 0 0 0 0 0</pose>
      <link name="link">
        <visual name="visual">
          <geometry>
            <box>
              <size>1 1 0.1</size>
            </box>
          </geometry>
        </visual>
        <collision name="collision">
          <geometry>
            <box>
              <size>1 1 0.1</size>
            </box>
          </geometry>
        </collision>
      </link>
    </model>
  </world>
</sdf>
```

## Scene Graph Architecture

The scene graph in Gazebo represents the hierarchical structure of objects in the simulation environment. This structure enables efficient rendering, physics calculations, and spatial relationships.

### Key Components of the Scene Graph

1. **World Node**: The root node containing all elements
2. **Model Nodes**: Represent individual objects (robots, furniture, etc.)
3. **Link Nodes**: Physical components of models with collision and visual properties
4. **Joint Nodes**: Define relationships between links
5. **Visual Nodes**: Define how objects appear
6. **Collision Nodes**: Define physics interactions

### Scene Graph Benefits

- **Performance**: Hierarchical culling improves rendering performance
- **Physics**: Efficient collision detection and response
- **Transforms**: Automatic coordinate system management
- **Animation**: Joint-based object movement and interaction

## World File Creation Process

### Step 1: Define Physics Properties

The physics configuration sets the fundamental behavior of the simulation environment:

```xml
<physics type="bullet">
  <gravity>0 0 -9.8</gravity>
  <max_step_size>0.001</max_step_size>
  <real_time_factor>1</real_time_factor>
  <real_time_update_rate>1000</real_time_update_rate>
  <ode>
    <solver>
      <type>quick</type>
      <iters>10</iters>
      <sor>1.3</sor>
    </solver>
    <constraints>
      <cfm>0.0</cfm>
      <erp>0.2</erp>
      <contact_max_correcting_vel>100.0</contact_max_correcting_vel>
      <contact_surface_layer>0.001</contact_surface_layer>
    </constraints>
  </ode>
</physics>
```

### Step 2: Add Environment Elements

Environment elements include the ground plane, sky, and lighting:

```xml
<include>
  <uri>model://ground_plane</uri>
</include>

<include>
  <uri>model://sun</uri>
</include>

<light name="sun_light" type="directional">
  <pose>0 0 10 0 0 0</pose>
  <diffuse>0.8 0.8 0.8 1</diffuse>
  <specular>0.2 0.2 0.2 1</specular>
  <attenuation>
    <range>1000</range>
    <constant>0.9</constant>
    <linear>0.01</linear>
    <quadratic>0.001</quadratic>
  </attenuation>
  <direction>-0.5 0.1 -0.9</direction>
</light>
```

### Step 3: Include Standard Models

Gazebo provides a library of standard models that can be included:

```xml
<include>
  <uri>model://cylinder</uri>
  <pose>1 0 0 0 0 0</pose>
</include>

<include>
  <uri>model://box</uri>
  <pose>2 0 0 0 0 0</pose>
</include>
```

## Best Practices for World Files

### Performance Optimization

- Use appropriate mesh complexity for objects
- Limit the number of dynamic objects
- Use static objects when possible
- Optimize collision geometries

### Organization

- Use descriptive names for models and objects
- Group related objects with consistent naming
- Document custom world files with comments
- Use consistent coordinate systems

### Validation

- Test physics stability with various objects
- Verify lighting and visual appearance
- Check collision detection accuracy
- Validate real-time performance

## Example: Indoor Office World

Here's a complete example of an indoor office world:

```xml
<?xml version="1.0" ?>
<sdf version="1.7">
  <world name="indoor_office">
    <!-- Physics configuration -->
    <physics type="bullet">
      <gravity>0 0 -9.8</gravity>
      <max_step_size>0.001</max_step_size>
      <real_time_factor>1</real_time_factor>
      <real_time_update_rate>1000</real_time_update_rate>
    </physics>

    <!-- Environment -->
    <include>
      <uri>model://ground_plane</uri>
    </include>

    <include>
      <uri>model://sun</uri>
    </include>

    <!-- Office furniture -->
    <model name="desk">
      <pose>0 0 0 0 0 0</pose>
      <link name="base">
        <visual name="visual">
          <geometry>
            <box>
              <size>1.5 0.8 0.75</size>
            </box>
          </geometry>
          <material>
            <ambient>0.8 0.6 0.4 1</ambient>
            <diffuse>0.8 0.6 0.4 1</diffuse>
          </material>
        </visual>
        <collision name="collision">
          <geometry>
            <box>
              <size>1.5 0.8 0.75</size>
            </box>
          </geometry>
        </collision>
      </link>
    </model>

    <model name="chair">
      <pose>0.8 0 0 0 0 0</pose>
      <link name="base">
        <visual name="visual">
          <geometry>
            <box>
              <size>0.5 0.5 0.45</size>
            </box>
          </geometry>
          <material>
            <ambient>0.6 0.6 0.6 1</ambient>
            <diffuse>0.6 0.6 0.6 1</diffuse>
          </material>
        </visual>
        <collision name="collision">
          <geometry>
            <box>
              <size>0.5 0.5 0.45</size>
            </box>
          </geometry>
        </collision>
      </link>
    </model>
  </world>
</sdf>
```

## Loading and Testing World Files

To load a world file in Gazebo:

```bash
gazebo /path/to/your/world_file.world
```

For ROS 2 integration:

```bash
ros2 launch gazebo_ros gazebo.launch.py world:=/path/to/your/world_file.world
```

## Summary

World files are fundamental to creating realistic simulation environments in Gazebo. Understanding the SDF format, scene graph architecture, and best practices enables the creation of complex, performant environments for robotics simulation and testing.

## References

1. Gazebo Documentation. (2023). Simulation Description Format (SDF). http://sdformat.org/
2. Open Source Robotics Foundation. (2023). Gazebo World Tutorial. https://gazebosim.org/tutorials?tut=build_world
3. Koenig, N., & Howard, A. (2004). Design and use paradigms for Gazebo. Proceedings of the 2004 IEEE/RSJ International Conference on Intelligent Robots and Systems.

## Exercises

1. Create a simple world file with a ground plane and two different objects
2. Modify physics parameters and observe the effects on simulation stability
3. Add lighting to your world and experiment with different light types
4. Include a standard model from Gazebo's model database in your world